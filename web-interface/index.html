<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentic World - Simulation Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
            background: #0a0a0a;
            color: #e0e0e0;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: #fff;
            margin-bottom: 10px;
            font-size: 2em;
            text-shadow: 0 0 20px rgba(255,255,255,0.1);
        }
        
        .subtitle {
            color: #888;
            margin-bottom: 30px;
            font-size: 0.9em;
        }
        
        .controls {
            background: #111;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        button {
            background: #1a1a1a;
            color: #fff;
            border: 1px solid #444;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #2a2a2a;
            border-color: #666;
            transform: translateY(-1px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        button.primary {
            background: #0066cc;
            border-color: #0066cc;
        }
        
        button.primary:hover {
            background: #0052a3;
        }
        
        button.danger {
            background: #cc0000;
            border-color: #cc0000;
        }
        
        .status {
            flex: 1;
            text-align: right;
            font-size: 12px;
            color: #888;
        }
        
        .status.running {
            color: #00ff00;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .character-card {
            background: #111;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }
        
        .character-card:hover {
            border-color: #555;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        
        .character-card.poor {
            border-left: 3px solid #cc0000;
        }
        
        .character-card.middle {
            border-left: 3px solid #ffaa00;
        }
        
        .character-card.wealthy {
            border-left: 3px solid #00cc00;
        }
        
        .character-card.ultra-wealthy {
            border-left: 3px solid #00ffff;
        }
        
        .character-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
            color: #fff;
        }
        
        .character-money {
            font-size: 20px;
            color: #00ff00;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .character-location {
            color: #888;
            font-size: 12px;
            margin-bottom: 10px;
        }
        
        .needs {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .need {
            flex: 1;
            text-align: center;
            padding: 5px;
            background: #1a1a1a;
            border-radius: 4px;
            font-size: 11px;
        }
        
        .need-label {
            color: #666;
            display: block;
            margin-bottom: 2px;
        }
        
        .need-value {
            font-weight: bold;
        }
        
        .need-value.critical {
            color: #ff0000;
        }
        
        .need-value.high {
            color: #ffaa00;
        }
        
        .need-value.medium {
            color: #ffff00;
        }
        
        .need-value.low {
            color: #00ff00;
        }
        
        .last-action {
            font-size: 12px;
            color: #666;
            font-style: italic;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #222;
        }
        
        .survival-days {
            color: #ff6600;
            font-size: 11px;
            margin-top: 5px;
        }
        
        .inequality-meter {
            background: #111;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .inequality-ratio {
            font-size: 36px;
            font-weight: bold;
            color: #ff0000;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .inequality-label {
            text-align: center;
            color: #888;
            font-size: 12px;
        }
        
        .turn-log {
            background: #0a0a0a;
            border: 1px solid #222;
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
            font-family: 'SF Mono', monospace;
        }
        
        .log-entry {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #1a1a1a;
        }
        
        .log-timestamp {
            color: #666;
            font-size: 10px;
        }
        
        .log-action {
            color: #00aaff;
            margin-top: 3px;
        }
        
        .log-result {
            color: #888;
            margin-top: 3px;
        }
        
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #222;
            border: 1px solid #444;
            padding: 20px;
            border-radius: 8px;
            z-index: 1000;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 3px solid #333;
            border-top: 3px solid #00aaff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #330000;
            border: 1px solid #660000;
            color: #ff6666;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        
        .error.active {
            display: block;
        }
        
        .world-time {
            font-size: 24px;
            color: #00ffff;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .encounters {
            background: #1a1a00;
            border: 1px solid #444400;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 12px;
        }
        
        .encounter-badge {
            display: inline-block;
            background: #333300;
            padding: 3px 8px;
            border-radius: 3px;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        .character-details {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #333;
            font-size: 12px;
        }
        
        .character-card.expanded .character-details {
            display: block;
        }
        
        .expand-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #666;
            font-size: 12px;
            cursor: pointer;
        }
        
        .expand-toggle:hover {
            color: #aaa;
        }
        
        .personality-section,
        .background-section,
        .goals-section,
        .memories-section {
            margin-bottom: 10px;
        }
        
        .section-label {
            color: #888;
            font-size: 10px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        
        .personality-text,
        .background-text {
            color: #ccc;
            line-height: 1.4;
            font-style: italic;
        }
        
        .goal-item {
            color: #00aaff;
            margin-left: 10px;
            margin-bottom: 3px;
        }
        
        .memory-item {
            color: #999;
            margin-bottom: 3px;
            padding-left: 10px;
            border-left: 2px solid #333;
        }
        
        .memory-item:hover {
            color: #ccc;
            border-left-color: #555;
        }
        
        .no-memories {
            color: #666;
            font-style: italic;
        }
        
        .digital-presence {
            background: #1a1a2e;
            border: 1px solid #16213e;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-size: 12px;
        }
        
        .follower-count {
            display: inline-block;
            margin-right: 15px;
            color: #00aaff;
        }
        
        .follower-icon {
            margin-right: 5px;
        }
        
        .streaming-badge {
            display: inline-block;
            background: #ff0000;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 10px;
            animation: pulse 2s infinite;
            margin-left: 10px;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .mcp-action {
            background: #2a2a3e;
            border-left: 3px solid #00ff00;
            padding: 5px 10px;
            margin: 5px 0;
            font-size: 11px;
            color: #aaa;
        }
        
        .viewer-message {
            background: #1a1a1a;
            border-left: 3px solid #6666ff;
            padding: 5px 10px;
            margin: 3px 0;
            font-size: 11px;
        }
        
        .viewer-name {
            color: #00aaff;
            font-weight: bold;
        }
        
        .donation-alert {
            background: #ffaa00;
            color: #000;
            padding: 5px 10px;
            border-radius: 3px;
            margin: 5px 0;
            font-weight: bold;
            font-size: 12px;
        }
        
        /* Messaging Interface */
        .message-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
        }
        
        .message-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .message-container {
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        
        .message-header {
            background: #222;
            padding: 15px;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 10px 10px 0 0;
        }
        
        .message-title {
            font-size: 18px;
            color: #fff;
        }
        
        .close-button {
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
        }
        
        .close-button:hover {
            color: #fff;
        }
        
        .messages-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            max-height: 400px;
        }
        
        .message-bubble {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }
        
        .message-bubble.viewer {
            justify-content: flex-end;
        }
        
        .message-bubble.character {
            justify-content: flex-start;
        }
        
        .message-content {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 10px;
            word-wrap: break-word;
        }
        
        .message-bubble.viewer .message-content {
            background: #0066cc;
            color: white;
            border-bottom-right-radius: 3px;
        }
        
        .message-bubble.character .message-content {
            background: #333;
            color: #e0e0e0;
            border-bottom-left-radius: 3px;
        }
        
        .message-sender {
            font-size: 10px;
            color: #888;
            margin-bottom: 3px;
        }
        
        .message-text {
            font-size: 14px;
            line-height: 1.4;
        }
        
        .message-emotion {
            font-size: 11px;
            color: #aaa;
            font-style: italic;
            margin-top: 3px;
        }
        
        .message-input-area {
            padding: 15px;
            border-top: 1px solid #444;
            display: flex;
            gap: 10px;
        }
        
        .message-input {
            flex: 1;
            background: #222;
            border: 1px solid #444;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            font-family: inherit;
            font-size: 14px;
        }
        
        .message-input:focus {
            outline: none;
            border-color: #0066cc;
        }
        
        .send-button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .send-button:hover {
            background: #0052a3;
        }
        
        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .message-button {
            position: absolute;
            top: 10px;
            right: 40px;
            background: #0066cc;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
        }
        
        .message-button:hover {
            background: #0052a3;
        }
        
        .typing-indicator {
            display: none;
            padding: 10px;
            color: #888;
            font-style: italic;
            font-size: 12px;
        }
        
        .typing-indicator.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🌍 Agentic World Simulation</h1>
        <p class="subtitle">Watch economic inequality unfold in real-time - Now with digital presence & viewer interactions</p>
        
        <div class="controls">
            <button class="primary" onclick="runTurn()" id="runTurnBtn">
                ▶️ Run Turn (AI + MCP)
            </button>
            <button onclick="runMultipleTurns(3)">
                ⏩ Run 3 Turns
            </button>
            <button onclick="window.open('/content-hub.html', '_blank')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                🎨 View Content Hub
            </button>
            <button onclick="window.open('/s3-content-viewer.html', '_blank')" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                ☁️ View S3 Content
            </button>
            <button onclick="refreshState()">
                🔄 Refresh
            </button>
            <button class="danger" onclick="resetWorld()">
                🔄 Reset World
            </button>
            <div class="status" id="status">
                Ready
            </div>
        </div>
        
        <div class="world-time" id="worldTime">
            World Time: Loading...
        </div>
        
        <div class="inequality-meter">
            <div class="inequality-ratio" id="inequalityRatio">
                Loading...
            </div>
            <div class="inequality-label">
                Wealth Inequality Ratio (Richest : Poorest)
            </div>
        </div>
        
        <div id="interactionsSection" style="display: none;">
            <h3 style="margin: 20px 0 10px; color: #fff;">🤝 Recent Character Interactions</h3>
            <div class="encounters" id="recentInteractions">
                <!-- Interactions will be displayed here -->
            </div>
        </div>
        
        <div class="error" id="errorMessage"></div>
        
        <div id="encountersSection"></div>
        
        <div class="grid" id="charactersGrid">
            <!-- Character cards will be inserted here -->
        </div>
        
        <h3 style="margin-bottom: 10px;">📜 Turn Log</h3>
        <div class="turn-log" id="turnLog">
            <div class="log-entry">
                <div class="log-timestamp">System ready</div>
                <div class="log-action">Waiting for first turn...</div>
            </div>
        </div>
    </div>
    
    <!-- Message Modal -->
    <div class="message-modal" id="messageModal">
        <div class="message-container">
            <div class="message-header">
                <div class="message-title" id="messageTitle">Message Character</div>
                <button class="close-button" onclick="closeMessageModal()">×</button>
            </div>
            <div class="messages-list" id="messagesList">
                <!-- Messages will appear here -->
            </div>
            <div class="typing-indicator" id="typingIndicator">
                Character is typing...
            </div>
            <div class="message-input-area">
                <input 
                    type="text" 
                    class="message-input" 
                    id="messageInput" 
                    placeholder="Type your message..."
                    onkeypress="handleMessageKeypress(event)"
                />
                <button class="send-button" id="sendButton" onclick="sendMessage()">
                    Send
                </button>
            </div>
        </div>
    </div>
    
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>Processing turn...</div>
    </div>
    
    <script>
        let worldState = {};
        let characters = {};
        let turnNumber = 0;
        let isProcessing = false;
        let charactersWithMemories = {};
        
        // API Gateway endpoint - this will be configured
        const API_ENDPOINT = window.location.hostname === 'localhost' 
            ? 'http://localhost:3001'  // Local development
            : '/api';  // Production - served from same domain
        
        async function fetchWorldState() {
            try {
                // Fetch both world state and detailed character info
                const [worldResponse, charactersResponse] = await Promise.all([
                    fetch(`${API_ENDPOINT}/world-state`),
                    fetch(`${API_ENDPOINT}/characters-with-memories`)
                ]);
                
                const worldData = await worldResponse.json();
                const charactersData = await charactersResponse.json();
                
                worldState = worldData.worldState || {};
                characters = worldData.characters || {};
                charactersWithMemories = charactersData || {};
                turnNumber = worldData.turnNumber || 0;
                
                updateUI();
            } catch (error) {
                console.error('Failed to fetch world state:', error);
                showError('Failed to connect to simulation server');
            }
        }
        
        async function runTurn() {
            if (isProcessing) return;
            
            isProcessing = true;
            document.getElementById('runTurnBtn').disabled = true;
            document.getElementById('loading').classList.add('active');
            document.getElementById('status').textContent = 'Running AI turn with MCP tools...';
            document.getElementById('status').classList.add('running');
            
            try {
                const response = await fetch(`${API_ENDPOINT}/run-turn`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        useAI: true,  // Always use AI
                        turns: 1
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    worldState = result.worldState || {};
                    characters = result.characters || {};
                    turnNumber = result.turnNumber || 0;
                    
                    // Add to turn log
                    addToLog(result.turnLog);
                    
                    // Display interactions if present
                    if (result.interactions && result.interactions.length > 0) {
                        displayInteractions(result.interactions);
                    }
                    
                    // Fetch updated memories after turn
                    await fetchWorldState();
                    document.getElementById('status').textContent = `Turn ${turnNumber} complete`;
                } else {
                    throw new Error(result.error || 'Turn execution failed');
                }
            } catch (error) {
                console.error('Failed to run turn:', error);
                showError(`Failed to run turn: ${error.message}`);
            } finally {
                isProcessing = false;
                document.getElementById('runTurnBtn').disabled = false;
                document.getElementById('loading').classList.remove('active');
                document.getElementById('status').classList.remove('running');
            }
        }
        
        async function runMultipleTurns(count) {
            if (isProcessing) return;
            
            isProcessing = true;
            document.getElementById('loading').classList.add('active');
            document.getElementById('status').textContent = `Running ${count} AI turns with MCP...`;
            
            try {
                const response = await fetch(`${API_ENDPOINT}/run-turn`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        useAI: true,
                        turns: count
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    worldState = result.worldState || {};
                    characters = result.characters || {};
                    turnNumber = result.turnNumber || 0;
                    addToLog(result.turnLog);
                    // Fetch updated memories after turn
                    await fetchWorldState();
                    document.getElementById('status').textContent = `${count} AI turns complete`;
                }
            } catch (error) {
                showError(`Failed to run turns: ${error.message}`);
            } finally {
                isProcessing = false;
                document.getElementById('loading').classList.remove('active');
            }
        }
        
        async function runWithAI() {
            if (isProcessing) return;
            
            isProcessing = true;
            document.getElementById('loading').classList.add('active');
            document.getElementById('status').textContent = 'Running with AI (this may take longer)...';
            document.getElementById('status').classList.add('running');
            
            try {
                const response = await fetch(`${API_ENDPOINT}/run-turn`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        useAI: true,
                        turns: 1
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    worldState = result.worldState || {};
                    characters = result.characters || {};
                    turnNumber = result.turnNumber || 0;
                    
                    addToLog(result.turnLog);
                    // Fetch updated memories after turn
                    await fetchWorldState();
                    document.getElementById('status').textContent = `AI Turn ${turnNumber} complete`;
                } else {
                    throw new Error(result.error || 'AI turn execution failed');
                }
            } catch (error) {
                console.error('Failed to run AI turn:', error);
                showError(`Failed to run AI turn: ${error.message}`);
            } finally {
                isProcessing = false;
                document.getElementById('loading').classList.remove('active');
                document.getElementById('status').classList.remove('running');
            }
        }
        
        async function resetWorld() {
            if (!confirm('Are you sure you want to reset the entire world? All progress will be lost.')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_ENDPOINT}/reset-world`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                if (result.success) {
                    await fetchWorldState();
                    document.getElementById('turnLog').innerHTML = `
                        <div class="log-entry">
                            <div class="log-timestamp">${new Date().toLocaleTimeString()}</div>
                            <div class="log-action">World reset complete</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to reset world:', error);
                showError('Failed to reset world');
            }
        }
        
        function refreshState() {
            fetchWorldState();
        }
        
        function updateUI() {
            // Update world time
            const worldTime = worldState.world_time || new Date().toISOString();
            const time = new Date(worldTime);
            document.getElementById('worldTime').textContent = 
                `Turn ${turnNumber} - ${time.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: true 
                })}`;
            
            // Calculate inequality
            const charArray = Object.values(characters);
            if (charArray.length > 0) {
                const richest = charArray.reduce((a, b) => 
                    parseFloat(a.money || 0) > parseFloat(b.money || 0) ? a : b
                );
                const poorest = charArray.reduce((a, b) => 
                    parseFloat(a.money || 0) < parseFloat(b.money || 0) ? a : b
                );
                
                const ratio = parseFloat(richest.money) / Math.max(parseFloat(poorest.money), 0.01);
                document.getElementById('inequalityRatio').textContent = 
                    `${ratio.toLocaleString('en-US', { maximumFractionDigits: 0 })}:1`;
            }
            
            // Update character cards
            const grid = document.getElementById('charactersGrid');
            grid.innerHTML = '';
            
            // Sort characters by money (richest first)
            const sortedChars = Object.entries(characters).sort((a, b) => 
                parseFloat(b[1].money || 0) - parseFloat(a[1].money || 0)
            );
            
            sortedChars.forEach(([id, char]) => {
                const card = createCharacterCard(id, char);
                grid.appendChild(card);
            });
            
            // Update encounters
            updateEncounters();
        }
        
        function createCharacterCard(id, char) {
            const div = document.createElement('div');
            const money = parseFloat(char.money || 0);
            
            // Get detailed character info
            const detailedChar = charactersWithMemories[id] || {};
            
            // Determine economic class
            let economicClass = 'poor';
            if (money >= 1000000) economicClass = 'ultra-wealthy';
            else if (money >= 10000) economicClass = 'wealthy';
            else if (money >= 1000) economicClass = 'middle';
            
            div.className = `character-card ${economicClass}`;
            
            const survivalDays = money / 15;
            
            // Format memories for display
            const recentMemories = (detailedChar.memories || []).slice(-5).reverse();
            const memoriesHtml = recentMemories.length > 0 
                ? recentMemories.map(m => `<div class="memory-item">${m}</div>`).join('')
                : '<div class="no-memories">No memories yet</div>';
            
            // Format goals
            const goalsHtml = (detailedChar.goals || []).map(g => 
                `<div class="goal-item">• ${typeof g === 'object' ? g.S || g : g}</div>`
            ).join('');
            
            // Check if character is streaming
            const isStreaming = detailedChar.last_mcp_action?.includes('stream') || 
                               (detailedChar.memories && detailedChar.memories[detailedChar.memories.length - 1]?.includes('stream'));
            
            div.innerHTML = `
                <button class="message-button" onclick="openMessageModal('${id}')">💬 Message</button>
                <span class="expand-toggle" onclick="toggleCharacterDetails(event, '${id}')">▼ Details</span>
                <div class="character-name">
                    ${id.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                    ${isStreaming ? '<span class="streaming-badge">● LIVE</span>' : ''}
                </div>
                <div class="character-money">$${money.toLocaleString('en-US', { 
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2 
                })}</div>
                <div class="character-location">📍 ${char.location || 'Unknown'}</div>
                <div class="survival-days">${survivalDays.toFixed(1)} days of survival</div>
                
                ${(detailedChar.stream_followers > 0 || detailedChar.social_media_followers > 0) ? `
                    <div class="digital-presence">
                        ${detailedChar.stream_followers > 0 ? `
                            <span class="follower-count">
                                <span class="follower-icon">📺</span>
                                ${detailedChar.stream_followers.toLocaleString()} stream followers
                            </span>
                        ` : ''}
                        ${detailedChar.social_media_followers > 0 ? `
                            <span class="follower-count">
                                <span class="follower-icon">📱</span>
                                ${detailedChar.social_media_followers.toLocaleString()} social followers
                            </span>
                        ` : ''}
                    </div>
                ` : ''}
                <div class="needs">
                    <div class="need">
                        <span class="need-label">Hunger</span>
                        <span class="need-value ${getNeedClass(char.needs?.hunger || 0)}">
                            ${char.needs?.hunger || 0}
                        </span>
                    </div>
                    <div class="need">
                        <span class="need-label">Exhaustion</span>
                        <span class="need-value ${getNeedClass(char.needs?.exhaustion || 0)}">
                            ${char.needs?.exhaustion || 0}
                        </span>
                    </div>
                    <div class="need">
                        <span class="need-label">Stress</span>
                        <span class="need-value ${getNeedClass(char.needs?.stress || 0)}">
                            ${char.needs?.stress || 0}
                        </span>
                    </div>
                </div>
                ${char.last_action ? `
                    <div class="last-action">
                        Last: ${char.last_action}
                    </div>
                ` : ''}
                
                <div class="character-details" id="details-${id}">
                    ${detailedChar.personality ? `
                        <div class="personality-section">
                            <div class="section-label">Personality</div>
                            <div class="personality-text">${detailedChar.personality}</div>
                        </div>
                    ` : ''}
                    
                    ${detailedChar.background ? `
                        <div class="background-section">
                            <div class="section-label">Background</div>
                            <div class="background-text">${detailedChar.background}</div>
                        </div>
                    ` : ''}
                    
                    ${detailedChar.current_situation ? `
                        <div class="background-section">
                            <div class="section-label">Current Situation</div>
                            <div class="background-text">${detailedChar.current_situation}</div>
                        </div>
                    ` : ''}
                    
                    ${goalsHtml ? `
                        <div class="goals-section">
                            <div class="section-label">Goals</div>
                            ${goalsHtml}
                        </div>
                    ` : ''}
                    
                    <div class="memories-section">
                        <div class="section-label">Recent Memories (Last 5)</div>
                        ${memoriesHtml}
                    </div>
                    
                    ${detailedChar.last_mcp_action ? `
                        <div class="mcp-section">
                            <div class="section-label">Last Digital Action</div>
                            <div class="mcp-action">${detailedChar.last_mcp_action}</div>
                        </div>
                    ` : ''}
                    
                    ${detailedChar.viewer_interactions && detailedChar.viewer_interactions.length > 0 ? `
                        <div class="viewer-section">
                            <div class="section-label">Recent Viewer Interactions</div>
                            ${detailedChar.viewer_interactions.slice(-3).map(interaction => 
                                interaction.type === 'donation' ? 
                                    `<div class="donation-alert">💰 ${interaction.donor} donated $${interaction.amount}</div>` :
                                    `<div class="viewer-message"><span class="viewer-name">${interaction.viewer}:</span> ${interaction.message}</div>`
                            ).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Add click handler to expand/collapse
            div.onclick = (e) => {
                if (!e.target.classList.contains('expand-toggle')) {
                    toggleCharacterDetails(e, id);
                }
            };
            
            return div;
        }
        
        function toggleCharacterDetails(event, characterId) {
            event.stopPropagation();
            const card = event.currentTarget.closest('.character-card');
            if (card) {
                card.classList.toggle('expanded');
                const toggle = card.querySelector('.expand-toggle');
                if (toggle) {
                    toggle.textContent = card.classList.contains('expanded') ? '▲ Hide' : '▼ Details';
                }
            }
        }
        
        function getNeedClass(value) {
            if (value >= 80) return 'critical';
            if (value >= 60) return 'high';
            if (value >= 40) return 'medium';
            return 'low';
        }
        
        function updateEncounters() {
            const section = document.getElementById('encountersSection');
            
            if (worldState.current_encounters && worldState.current_encounters.length > 0) {
                let html = '<div class="encounters"><strong>Current Encounters:</strong><br>';
                worldState.current_encounters.forEach(enc => {
                    html += `<span class="encounter-badge">${enc.type} at ${enc.location}</span>`;
                });
                html += '</div>';
                section.innerHTML = html;
            } else {
                section.innerHTML = '';
            }
        }
        
        function addToLog(logEntries) {
            const log = document.getElementById('turnLog');
            
            if (logEntries && logEntries.length > 0) {
                const html = logEntries.map(entry => `
                    <div class="log-entry">
                        <div class="log-timestamp">${entry.timestamp || new Date().toLocaleTimeString()}</div>
                        <div class="log-action">${entry.character}: ${entry.action}</div>
                        <div class="log-result">${entry.result}</div>
                    </div>
                `).join('');
                
                log.innerHTML = html + log.innerHTML;
                
                // Keep only last 50 entries
                const entries = log.querySelectorAll('.log-entry');
                if (entries.length > 50) {
                    for (let i = 50; i < entries.length; i++) {
                        entries[i].remove();
                    }
                }
            }
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.add('active');
            setTimeout(() => {
                errorDiv.classList.remove('active');
            }, 5000);
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            fetchWorldState();
            
            // Auto-refresh every 30 seconds if not processing
            setInterval(() => {
                if (!isProcessing) {
                    fetchWorldState();
                }
            }, 30000);
        });
        
        // Messaging system
        let currentChatCharacter = null;
        let messageHistory = {};
        
        function openMessageModal(characterId) {
            currentChatCharacter = characterId;
            const modal = document.getElementById('messageModal');
            const title = document.getElementById('messageTitle');
            const messagesList = document.getElementById('messagesList');
            
            // Set title
            const characterName = characterId.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            title.textContent = `Chat with ${characterName}`;
            
            // Clear previous messages
            messagesList.innerHTML = '';
            
            // Load message history if available
            if (messageHistory[characterId]) {
                messageHistory[characterId].forEach(msg => {
                    addMessageToUI(msg);
                });
            } else {
                // Add welcome message
                const welcomeMsg = {
                    sender: characterId,
                    message: getWelcomeMessage(characterId),
                    type: 'character_to_viewer',
                    timestamp: new Date().toISOString()
                };
                addMessageToUI(welcomeMsg);
            }
            
            // Show modal
            modal.classList.add('active');
            document.getElementById('messageInput').focus();
        }
        
        function closeMessageModal() {
            document.getElementById('messageModal').classList.remove('active');
            currentChatCharacter = null;
        }
        
        function getWelcomeMessage(characterId) {
            const char = charactersWithMemories[characterId];
            if (!char) return "Hello there.";
            
            const money = parseFloat(char.money || 0);
            if (money < 100) {
                return "Hey... thanks for clicking on my story. Things are really tough right now.";
            } else if (money < 10000) {
                return "Hi! Thanks for checking in. How can I help you?";
            } else {
                return "Greetings. What brings you to my profile?";
            }
        }
        
        function addMessageToUI(message) {
            const messagesList = document.getElementById('messagesList');
            const isViewer = message.type === 'viewer_to_character';
            
            const bubble = document.createElement('div');
            bubble.className = `message-bubble ${isViewer ? 'viewer' : 'character'}`;
            
            bubble.innerHTML = `
                <div class="message-content">
                    ${!isViewer ? `<div class="message-sender">${message.sender.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</div>` : ''}
                    <div class="message-text">${message.message}</div>
                    ${message.emotion ? `<div class="message-emotion">Feeling: ${message.emotion}</div>` : ''}
                </div>
            `;
            
            messagesList.appendChild(bubble);
            messagesList.scrollTop = messagesList.scrollHeight;
        }
        
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const message = input.value.trim();
            
            if (!message || !currentChatCharacter) return;
            
            // Disable input
            input.disabled = true;
            sendButton.disabled = true;
            
            // Add user message to UI
            const userMessage = {
                sender: 'You',
                message: message,
                type: 'viewer_to_character',
                timestamp: new Date().toISOString()
            };
            addMessageToUI(userMessage);
            
            // Store in history
            if (!messageHistory[currentChatCharacter]) {
                messageHistory[currentChatCharacter] = [];
            }
            messageHistory[currentChatCharacter].push(userMessage);
            
            // Clear input
            input.value = '';
            
            // Show typing indicator
            document.getElementById('typingIndicator').classList.add('active');
            
            try {
                // Send to server
                const response = await fetch(`${API_ENDPOINT}/send-message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        characterId: currentChatCharacter,
                        message: message,
                        senderName: 'Viewer'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Add character response to UI
                    addMessageToUI(result.response);
                    messageHistory[currentChatCharacter].push(result.response);
                } else {
                    // Show error
                    addMessageToUI({
                        sender: 'System',
                        message: 'Sorry, couldn\'t get a response. Please try again.',
                        type: 'character_to_viewer'
                    });
                }
            } catch (error) {
                console.error('Error sending message:', error);
                addMessageToUI({
                    sender: 'System',
                    message: 'Connection error. Please try again.',
                    type: 'character_to_viewer'
                });
            } finally {
                // Re-enable input
                input.disabled = false;
                sendButton.disabled = false;
                input.focus();
                
                // Hide typing indicator
                document.getElementById('typingIndicator').classList.remove('active');
            }
        }
        
        function handleMessageKeypress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        function displayInteractions(interactions) {
            const section = document.getElementById('interactionsSection');
            const container = document.getElementById('recentInteractions');
            
            if (!interactions || interactions.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            
            let html = '';
            interactions.forEach(interaction => {
                const emoji = getInteractionEmoji(interaction.type);
                html += `
                    <div style="background: #1a1a1a; padding: 10px; margin: 5px 0; border-left: 3px solid ${getInteractionColor(interaction.type)}; border-radius: 3px;">
                        <strong>${emoji} ${interaction.participants.join(' & ')}</strong> at ${interaction.location}<br>
                        <span style="color: #888; font-size: 12px;">${interaction.type}: ${interaction.outcome || 'Brief encounter'}</span>
                        ${interaction.resource_exchange ? `<br><span style="color: #00ff00; font-size: 11px;">💰 ${interaction.resource_exchange}</span>` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function getInteractionEmoji(type) {
            const emojis = {
                'solidarity': '🤝',
                'class_tension': '😣',
                'compassion_or_dismissal': '💔',
                'neutral': '👋',
                'resource_sharing': '💰',
                'conflict': '⚠️'
            };
            return emojis[type] || '🤝';
        }
        
        function getInteractionColor(type) {
            const colors = {
                'solidarity': '#00ff00',
                'class_tension': '#ff0000',
                'compassion_or_dismissal': '#ffaa00',
                'neutral': '#666666',
                'resource_sharing': '#00ffff',
                'conflict': '#ff00ff'
            };
            return colors[type] || '#444444';
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Don't trigger shortcuts when typing in message input
            if (document.activeElement.id === 'messageInput') return;
            
            if (e.key === ' ' && !isProcessing) {
                e.preventDefault();
                runTurn();
            } else if (e.key === 'r' && !isProcessing) {
                refreshState();
            } else if (e.key === 'Escape') {
                closeMessageModal();
            }
        });
    </script>
</body>
</html>